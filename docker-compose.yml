version: '3.8'

services:
  frontend:
    build: 
      context: ./agno-frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      # Usar volumes nomeados ao invés de bind mounts para evitar problemas de permissão
      - frontend_node_modules:/app/node_modules
      - frontend_next:/app/.next
      - frontend_turbo:/app/.turbo
      # Apenas código fonte como bind mount
      - ./agno-frontend/src:/app/src:ro
      - ./agno-frontend/public:/app/public:ro
      - ./agno-frontend/package.json:/app/package.json:ro
      - ./agno-frontend/tailwind.config.js:/app/tailwind.config.js:ro
      - ./agno-frontend/tsconfig.json:/app/tsconfig.json:ro
    environment:
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      - WATCHPACK_POLLING=true
      - NEXT_CONFIG_WATCH=false
    # Corrigir usuário para evitar problemas de permissão
    user: "1001:1001"
    depends_on:
      - backend

  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - backend_logs:/app/logs
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
    env_file:
      - .env
    depends_on:
      - postgres

  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: agno_db
      POSTGRES_USER: agno_user
      POSTGRES_PASSWORD: agno_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  # Volumes nomeados para evitar problemas de permissão
  frontend_node_modules:
  frontend_next:
  frontend_turbo:
  backend_logs:
  postgres_data: